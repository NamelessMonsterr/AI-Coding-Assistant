<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--vscode-font-family);
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #model-selector {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        #model-selector:hover {
            background: var(--vscode-button-hoverBackground);
        }

        #context-panel {
            padding: 12px 16px;
            border-bottom: 1px solid var(--vscode-panel-border);
            background: var(--vscode-sideBar-background);
        }

        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .context-header h4 {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
        }

        .context-actions {
            display: flex;
            gap: 4px;
        }

        .context-btn {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .context-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        .current-file {
            padding: 6px;
            background: var(--vscode-input-background);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .context-files {
            max-height: 120px;
            overflow-y: auto;
        }

        .context-file {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            margin-bottom: 2px;
            background: var(--vscode-input-background);
            border-radius: 3px;
            font-size: 11px;
        }

        .context-file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .remove-file-btn {
            background: none;
            border: none;
            color: var(--vscode-errorForeground);
            cursor: pointer;
            padding: 0 4px;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .user-message {
            background: var(--vscode-inputValidation-infoBorder);
            align-self: flex-end;
            margin-left: auto;
        }

        .assistant-message {
            background: var(--vscode-editor-inactiveSelectionBackground);
            align-self: flex-start;
        }

        .system-message {
            background: var(--vscode-inputValidation-warningBackground);
            align-self: center;
            font-size: 12px;
            max-width: 95%;
        }

        .message pre {
            background: var(--vscode-textBlockQuote-background);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message code {
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
        }

        .code-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .code-action-btn {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .code-action-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        #loading-indicator {
            display: none;
            padding: 8px 12px;
            color: var(--vscode-descriptionForeground);
            font-style: italic;
        }

        #loading-indicator.active {
            display: block;
        }

        #input-container {
            padding: 16px;
            border-top: 1px solid var(--vscode-panel-border);
            display: flex;
            gap: 8px;
        }

        #message-input {
            flex: 1;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            padding: 10px 12px;
            border-radius: 6px;
            font-family: var(--vscode-font-family);
            font-size: 13px;
            resize: none;
            max-height: 120px;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--vscode-focusBorder);
        }

        #send-button {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        #send-button:hover {
            background: var(--vscode-button-hoverBackground);
        }

        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--vscode-descriptionForeground);
        }

        .welcome-message h2 {
            margin-bottom: 16px;
            color: var(--vscode-foreground);
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 24px;
        }

        .quick-action-btn {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
        }

        .quick-action-btn:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--vscode-editor-background);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--vscode-scrollbarSlider-background);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--vscode-scrollbarSlider-hoverBackground);
        }
    </style>
</head>
<body>
    <div id="chat-header">
        <h3>ü§ñ AI Assistant</h3>
        <button id="model-selector" onclick="selectModel()">Select Model</button>
    </div>

    <div id="context-panel">
        <div class="context-header">
            <h4>üìÅ CONTEXT</h4>
            <div class="context-actions">
                <button class="context-btn" onclick="addCurrentFile()" title="Add current file">+ Current</button>
                <button class="context-btn" onclick="addFile()" title="Add file">+ File</button>
                <button class="context-btn" onclick="analyzeWorkspace()" title="Analyze workspace">üîç Analyze</button>
                <button class="context-btn" onclick="clearContext()" title="Clear context">‚úï Clear</button>
            </div>
        </div>
        <div id="current-file-container"></div>
        <div id="context-files-container" class="context-files"></div>
    </div>

    <div id="chat-container">
        <div class="welcome-message">
            <h2>üëã Hello! I'm your AI Coding Assistant</h2>
            <p>I can see your current file and analyze multiple files at once!</p>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('Generate a Python function to sort a list')">
                    ‚ú® Generate Code
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Review my current code for bugs and improvements')">
                    ‚úÖ Review Current File
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Explain the selected code in detail')">
                    üìñ Explain Selected Code
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Analyze the relationships between files in context')">
                    üîó Analyze Multi-File Dependencies
                </button>
            </div>
        </div>
    </div>

    <div id="loading-indicator">
        <span>AI is thinking...</span>
    </div>

    <div id="input-container">
        <textarea
            id="message-input"
            placeholder="Ask me anything about your code..."
            rows="1"
            onkeydown="handleKeyPress(event)"
        ></textarea>
        <button id="send-button" onclick="sendMessage()">Send</button>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let isLoading = false;

        // Auto-resize textarea
        const textarea = document.getElementById('message-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message || isLoading) return;

            input.value = '';
            input.style.height = 'auto';

            vscode.postMessage({
                type: 'sendMessage',
                message: message
            });
        }

        function sendQuickMessage(message) {
            vscode.postMessage({
                type: 'sendMessage',
                message: message
            });
        }

        function selectModel() {
            vscode.postMessage({ type: 'selectModel' });
        }

        function addCurrentFile() {
            vscode.postMessage({ type: 'addCurrentFile' });
        }

        function addFile() {
            vscode.postMessage({ type: 'addFileToContext' });
        }

        function analyzeWorkspace() {
            vscode.postMessage({ type: 'analyzeWorkspace' });
        }

        function removeFile(filePath) {
            vscode.postMessage({ type: 'removeFile', file: filePath });
        }

        function clearContext() {
            vscode.postMessage({ type: 'clearContext' });
        }

        function insertCode(code) {
            vscode.postMessage({
                type: 'insertCode',
                code: code
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code);
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.type) {
                case 'updateChat':
                    updateChatDisplay(message.messages);
                    break;
                case 'updateContext':
                    updateContextDisplay(message);
                    break;
                case 'loading':
                    isLoading = message.value;
                    document.getElementById('loading-indicator').classList.toggle('active', message.value);
                    document.getElementById('send-button').disabled = message.value;
                    break;
            }
        });

        function updateChatDisplay(messages) {
            const container = document.getElementById('chat-container');

            const welcome = container.querySelector('.welcome-message');
            if (welcome && messages.length > 0) {
                welcome.remove();
            }

            if (messages.length > 0) {
                container.innerHTML = '';
                messages.forEach(function(msg) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message ' + msg.role + '-message';

                    let content = msg.content;
                    content = content.replace(/\`\`\`([\s\S]*?)\`\`\`/g, function(match, code) {
                        return '<pre><code>' + escapeHtml(code) + '</code></pre>' +
                               '<div class="code-actions">' +
                               '<button class="code-action-btn" onclick="insertCode(\'' + escapeHtml(code).replace(/'/g, '\\\'') + '\')">Insert</button>' +
                               '<button class="code-action-btn" onclick="copyCode(\'' + escapeHtml(code).replace(/'/g, '\\\'') + '\')">Copy</button>' +
                               '</div>';
                    });

                    messageDiv.innerHTML = content;
                    container.appendChild(messageDiv);
                });

                container.scrollTop = container.scrollHeight;
            }
        }

        function updateContextDisplay(data) {
            // Update current file
            const currentFileContainer = document.getElementById('current-file-container');
            if (data.currentFile) {
                currentFileContainer.innerHTML =
                    '<div class="current-file">' +
                        'üìÑ <strong>Current:</strong> ' + data.currentFile.name + ' (' + data.currentFile.language + ')' +
                    '</div>';
            } else {
                currentFileContainer.innerHTML = '';
            }

            // Update context files
            const contextContainer = document.getElementById('context-files-container');
            if (data.contextFiles && data.contextFiles.length > 0) {
                contextContainer.innerHTML = data.contextFiles.map(function(file) {
                    return '<div class="context-file">' +
                           '<span class="context-file-name" title="' + file.path + '">üìé ' + file.name + '</span>' +
                           '<button class="remove-file-btn" onclick="removeFile(\'' + file.path.replace(/\\/g, '\\\\') + '\')">‚úï</button>' +
                           '</div>';
                }).join('');
            } else {
                contextContainer.innerHTML = '<div style="font-size: 11px; color: var(--vscode-descriptionForeground); padding: 4px;">No files in context</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
